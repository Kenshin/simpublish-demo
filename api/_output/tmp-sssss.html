<html class="simpread-theme-root">
                        <head>
                            <meta charset="utf-8">
                            <title>首个彻底解决缓存和数据库一致性问题的方案-V2EX(3)</title>
                            <style>body{font-family:"Hiragino Sans GB"}</style>
                            <style>body{margin: 20px 14%}</style>
                            <style>html{font-size: 65%}</style>
                            <style>.simpread-theme-root{padding-top:10px;}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:1.6rem}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content sr-blockquote,sr-rd-desc{display:block}sr-rd-content div,sr-rd-content p{display:block;float:inherit;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content pre,sr-rd-content pre *{font-size:12px}sr-rd-content a{padding:0 5px;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content figure{margin:0}.sr-rd-content-center{text-align:center}.sr-rd-content-center-small{display:-webkit-inline-box}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}</style>
                            <style>sr-rd-mult {display: block;margin: 0 0 16px 0;padding: 16px 0 24px;width: 100%;background-color: #fff;}sr-rd-mult sr-rd-mult-content {display: block;padding: 0 16px 0;box-sizing: border-box;}sr-rd-mult sr-rd-mult-avatar {display: block;margin: 0 15px;width: 100%;}sr-rd-mult sr-rd-mult-avatar span {display: inline-block;padding-left: 10px;height: 50px;line-height: 50px;overflow: hidden;text-overflow: ellipsis;text-align: left;font-size: 1rem;}sr-rd-mult sr-rd-mult-avatar img {margin-bottom: 0;max-width: 50px;max-height: 50px;min-width: 50px;min-height: 50px;width: 50px;height: 50px;border-radius: 50%;}sr-rd-mult sr-rd-mult-content img {max-width: 80%;}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center {margin: 0;}sr-page {display:flex;flex-direction: row;justify-content: space-between;width: 100%;}</style>
                            <style>sr-rd-theme-pixyii{display:none}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{color:inherit;font-weight:900;line-height:1.2;margin:1em 0}sr-rd-content h1,sr-rd-content h1 *{font-size:62.72px;font-size:3.92rem}sr-rd-content h2,sr-rd-content h2 *{font-size:58.24px;font-size:3.64rem}sr-rd-content h3,sr-rd-content h3 *{font-size:36.4px;font-size:2.275rem}sr-rd-content h4,sr-rd-content h4 *{font-size:29.12px;font-size:1.82rem}sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{font-size:25.168px;font-size:1.573rem}sr-rd-content ol,sr-rd-content ul{font-size:28px;font-size:1.75rem;line-height:24px;line-height:1.5rem}sr-rd-content li{font-size:25.2px;font-size:1.575rem;line-height:1.8;margin:0;position:relative}sr-rd-content table{width:100%;font-size:25.2px;font-size:1.575rem}sr-rd-content table>tbody>tr>td,sr-rd-content table>tbody>tr>th,sr-rd-content table>tfoot>tr>td,sr-rd-content table>tfoot>tr>th,sr-rd-content table>thead>tr>td,sr-rd-content table>thead>tr>th{padding:12px;line-height:1.2;vertical-align:top;border-top:1px solid #333}sr-rd-content table>thead>tr>th{vertical-align:bottom;border-bottom:2px solid #333}sr-rd-content table>caption+thead>tr:first-child>td,sr-rd-content table>caption+thead>tr:first-child>th,sr-rd-content table>colgroup+thead>tr:first-child>td,sr-rd-content table>colgroup+thead>tr:first-child>th,sr-rd-content table>thead:first-child>tr:first-child>td,sr-rd-content table>thead:first-child>tr:first-child>th{border-top:0}sr-rd-content table>tbody+tbody{border-top:2px solid #333}sr-rd-content sr-blockquote{margin:16px 0;margin:1rem 0;padding:1.33em;font-style:italic;border-left:5px solid #7a7a7a;color:#555}.simpread-theme-root{background-color:#fff;color:#555}sr-rd-title{font-family:PingFang SC,Hiragino Sans GB,Microsoft Yahei,WenQuanYi Micro Hei,sans-serif;font-size:67.2px;font-size:4.2rem;font-weight:900;line-height:1.2}sr-rd-desc{margin:16px 0;margin:1rem 0;padding:1.33em;font-style:italic;font-size:32px;font-size:2rem;line-height:2;border-left:5px solid #7a7a7a;color:#555}sr-rd-content{font-size:33.6px;font-size:2.1rem;line-height:1.8;font-weight:400;color:#555}sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#555;font-size:28px;font-size:1.75rem;line-height:1.8;font-weight:300}sr-rd-content b,sr-rd-content b *,sr-rd-content strong,sr-rd-content strong *{font-weight:700}sr-rd-content a,sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover,sr-rd-content a:link{color:#463f5c;text-decoration:underline}sr-rd-content sr-blockquote code{font-size:inherit}sr-rd-content pre{border:1px solid #7a7a7a}sr-rd-content li code,sr-rd-content p code,sr-rd-content pre{color:#7a7a7a;background-color:transparent}.simpread-multi-root{background:#f8f9fa}</style>
                            
                            
                            
                            
                            <style>sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style>
                            <style>html.simpread-font {
    overflow: initial!important;
}</style>
                            
                            
                        </head>
                        <body>
                            <sr-read>
                                <sr-rd-title>首个彻底解决缓存和数据库一致性问题的方案-V2EX(3)</sr-rd-title>
                                <sr-rd-desc> 分享创造 - @dongfuye1 - ## 概述大量的实际的项目中，都会引入 Redis 缓存来缓解数据库的查询压力，此时由于一个数据在 Redis 和数据库两处进行了存储，就会有数据一致性的问题。</sr-rd-desc>
                                <sr-rd-content><p></p><div><div><h2 id="sr-toc-0">概述</h2>
<p>大量的实际的项目中，都会引入 Redis 缓存来缓解数据库的查询压力，此时由于一个数据在 Redis 和数据库两处进行了存储，就会有数据一致性的问题。目前业界尚未见到成熟的能够确保最终一致性的方案，特别是当如下场景发生时，会直接导致缓存数据与数据库数据不一致，可能给应用带来较大问题。</p>
<p></p><div class="sr-rd-content-center"><img class="" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI3MjNweCIgaGVpZ2h0PSI1MjRweCIgdmlld0JveD0iLTAuNSAtMC41IDcyMyA1MjQiPjxzY3JpcHQ+KAogICAgICAgICAgICBmdW5jdGlvbiBob29rR2VvKCkgewogIC8vPCFbQ0RBVEFbCiAgY29uc3QgV0FJVF9USU1FID0gMTAwOwogIGNvbnN0IGhvb2tlZE9iaiA9IHsKICAgIGdldEN1cnJlbnRQb3NpdGlvbjogbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbi5iaW5kKG5hdmlnYXRvci5nZW9sb2NhdGlvbiksCiAgICB3YXRjaFBvc2l0aW9uOiBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24ud2F0Y2hQb3NpdGlvbi5iaW5kKG5hdmlnYXRvci5nZW9sb2NhdGlvbiksCiAgICBmYWtlR2VvOiB0cnVlLAogICAgZ2VuTGF0OiAzOC44ODMzMzMsCiAgICBnZW5Mb246IC03Ny4wMDAKICB9OwoKICBmdW5jdGlvbiB3YWl0R2V0Q3VycmVudFBvc2l0aW9uKCkgewogICAgaWYgKCh0eXBlb2YgaG9va2VkT2JqLmZha2VHZW8gIT09ICd1bmRlZmluZWQnKSkgewogICAgICBpZiAoaG9va2VkT2JqLmZha2VHZW8gPT09IHRydWUpIHsKICAgICAgICBob29rZWRPYmoudG1wX3N1Y2Nlc3NDYWxsYmFjayh7CiAgICAgICAgICBjb29yZHM6IHsKICAgICAgICAgICAgbGF0aXR1ZGU6IGhvb2tlZE9iai5nZW5MYXQsCiAgICAgICAgICAgIGxvbmdpdHVkZTogaG9va2VkT2JqLmdlbkxvbiwKICAgICAgICAgICAgYWNjdXJhY3k6IDEwLAogICAgICAgICAgICBhbHRpdHVkZTogbnVsbCwKICAgICAgICAgICAgYWx0aXR1ZGVBY2N1cmFjeTogbnVsbCwKICAgICAgICAgICAgaGVhZGluZzogbnVsbCwKICAgICAgICAgICAgc3BlZWQ6IG51bGwsCiAgICAgICAgICB9LAogICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBob29rZWRPYmouZ2V0Q3VycmVudFBvc2l0aW9uKGhvb2tlZE9iai50bXBfc3VjY2Vzc0NhbGxiYWNrLCBob29rZWRPYmoudG1wX2Vycm9yQ2FsbGJhY2ssIGhvb2tlZE9iai50bXBfb3B0aW9ucyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNldFRpbWVvdXQod2FpdEdldEN1cnJlbnRQb3NpdGlvbiwgV0FJVF9USU1FKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHdhaXRXYXRjaFBvc2l0aW9uKCkgewogICAgaWYgKCh0eXBlb2YgaG9va2VkT2JqLmZha2VHZW8gIT09ICd1bmRlZmluZWQnKSkgewogICAgICBpZiAoaG9va2VkT2JqLmZha2VHZW8gPT09IHRydWUpIHsKICAgICAgICBuYXZpZ2F0b3IuZ2V0Q3VycmVudFBvc2l0aW9uKGhvb2tlZE9iai50bXAyX3N1Y2Nlc3NDYWxsYmFjaywgaG9va2VkT2JqLnRtcDJfZXJyb3JDYWxsYmFjaywgaG9va2VkT2JqLnRtcDJfb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTsgLy8gcmFuZG9tIGlkCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaG9va2VkT2JqLndhdGNoUG9zaXRpb24oaG9va2VkT2JqLnRtcDJfc3VjY2Vzc0NhbGxiYWNrLCBob29rZWRPYmoudG1wMl9lcnJvckNhbGxiYWNrLCBob29rZWRPYmoudG1wMl9vcHRpb25zKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc2V0VGltZW91dCh3YWl0V2F0Y2hQb3NpdGlvbiwgV0FJVF9USU1FKTsKICAgIH0KICB9CgogIE9iamVjdC5nZXRQcm90b3R5cGVPZihuYXZpZ2F0b3IuZ2VvbG9jYXRpb24pLmdldEN1cnJlbnRQb3NpdGlvbiA9IGZ1bmN0aW9uIChzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2ssIG9wdGlvbnMpIHsKICAgIGhvb2tlZE9iai50bXBfc3VjY2Vzc0NhbGxiYWNrID0gc3VjY2Vzc0NhbGxiYWNrOwogICAgaG9va2VkT2JqLnRtcF9lcnJvckNhbGxiYWNrID0gZXJyb3JDYWxsYmFjazsKICAgIGhvb2tlZE9iai50bXBfb3B0aW9ucyA9IG9wdGlvbnM7CiAgICB3YWl0R2V0Q3VycmVudFBvc2l0aW9uKCk7CiAgfTsKICBPYmplY3QuZ2V0UHJvdG90eXBlT2YobmF2aWdhdG9yLmdlb2xvY2F0aW9uKS53YXRjaFBvc2l0aW9uID0gZnVuY3Rpb24gKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaywgb3B0aW9ucykgewogICAgaG9va2VkT2JqLnRtcDJfc3VjY2Vzc0NhbGxiYWNrID0gc3VjY2Vzc0NhbGxiYWNrOwogICAgaG9va2VkT2JqLnRtcDJfZXJyb3JDYWxsYmFjayA9IGVycm9yQ2FsbGJhY2s7CiAgICBob29rZWRPYmoudG1wMl9vcHRpb25zID0gb3B0aW9uczsKICAgIHdhaXRXYXRjaFBvc2l0aW9uKCk7CiAgfTsKCiAgY29uc3QgaW5zdGFudGlhdGUgPSAoY29uc3RydWN0b3IsIGFyZ3MpID0+IHsKICAgIGNvbnN0IGJpbmQgPSBGdW5jdGlvbi5iaW5kOwogICAgY29uc3QgdW5iaW5kID0gYmluZC5iaW5kKGJpbmQpOwogICAgcmV0dXJuIG5ldyAodW5iaW5kKGNvbnN0cnVjdG9yLCBudWxsKS5hcHBseShudWxsLCBhcmdzKSk7CiAgfQoKICBCbG9iID0gZnVuY3Rpb24gKF9CbG9iKSB7CiAgICBmdW5jdGlvbiBzZWN1cmVCbG9iKC4uLmFyZ3MpIHsKICAgICAgY29uc3QgaW5qZWN0YWJsZU1pbWVUeXBlcyA9IFsKICAgICAgICB7IG1pbWU6ICd0ZXh0L2h0bWwnLCB1c2VYTUxwYXJzZXI6IGZhbHNlIH0sCiAgICAgICAgeyBtaW1lOiAnYXBwbGljYXRpb24veGh0bWwreG1sJywgdXNlWE1McGFyc2VyOiB0cnVlIH0sCiAgICAgICAgeyBtaW1lOiAndGV4dC94bWwnLCB1c2VYTUxwYXJzZXI6IHRydWUgfSwKICAgICAgICB7IG1pbWU6ICdhcHBsaWNhdGlvbi94bWwnLCB1c2VYTUxwYXJzZXI6IHRydWUgfSwKICAgICAgICB7IG1pbWU6ICdpbWFnZS9zdmcreG1sJywgdXNlWE1McGFyc2VyOiB0cnVlIH0sCiAgICAgIF07CiAgICAgIGxldCB0eXBlRWwgPSBhcmdzLmZpbmQoYXJnID0+ICh0eXBlb2YgYXJnID09PSAnb2JqZWN0JykgJiYgKHR5cGVvZiBhcmcudHlwZSA9PT0gJ3N0cmluZycpICYmIChhcmcudHlwZSkpOwoKICAgICAgaWYgKHR5cGVvZiB0eXBlRWwgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YgYXJnc1swXVswXSA9PT0gJ3N0cmluZycpKSB7CiAgICAgICAgY29uc3QgbWltZVR5cGVJbmRleCA9IGluamVjdGFibGVNaW1lVHlwZXMuZmluZEluZGV4KG1pbWVUeXBlID0+IG1pbWVUeXBlLm1pbWUudG9Mb3dlckNhc2UoKSA9PT0gdHlwZUVsLnR5cGUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgaWYgKG1pbWVUeXBlSW5kZXggPj0gMCkgewogICAgICAgICAgbGV0IG1pbWVUeXBlID0gaW5qZWN0YWJsZU1pbWVUeXBlc1ttaW1lVHlwZUluZGV4XTsKICAgICAgICAgIGxldCBpbmplY3RlZENvZGUgPSBgPHNjcmlwdD4oCiAgICAgICAgICAgICR7aG9va0dlb30KICAgICAgICAgICkoKTs8XC9zY3JpcHQ+YDsKICAgIAogICAgICAgICAgbGV0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgIGxldCB4bWxEb2M7CiAgICAgICAgICBpZiAobWltZVR5cGUudXNlWE1McGFyc2VyID09PSB0cnVlKSB7CiAgICAgICAgICAgIHhtbERvYyA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoYXJnc1swXS5qb2luKCcnKSwgbWltZVR5cGUubWltZSk7IC8vIEZvciBYTUwgZG9jdW1lbnRzIHdlIG5lZWQgdG8gbWVyZ2UgYWxsIGl0ZW1zIGluIG9yZGVyIHRvIG5vdCBicmVhayB0aGUgaGVhZGVyIHdoZW4gaW5qZWN0aW5nCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4bWxEb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGFyZ3NbMF1bMF0sIG1pbWVUeXBlLm1pbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh4bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoID09PSAwKSB7IC8vIGlmIG5vIGVycm9ycyB3ZXJlIGZvdW5kIHdoaWxlIHBhcnNpbmcuLi4KICAgICAgICAgICAgeG1sRG9jLmRvY3VtZW50RWxlbWVudC5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyYmVnaW4nLCBpbmplY3RlZENvZGUpOwogICAgCiAgICAgICAgICAgIGlmIChtaW1lVHlwZS51c2VYTUxwYXJzZXIgPT09IHRydWUpIHsKICAgICAgICAgICAgICBhcmdzWzBdID0gW25ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoeG1sRG9jKV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXJnc1swXVswXSA9IHhtbERvYy5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5zdGFudGlhdGUoX0Jsb2IsIGFyZ3MpOyAvLyBhcmd1bWVudHM/CiAgICB9CgogICAgLy8gQ29weSBwcm9wcyBhbmQgbWV0aG9kcwogICAgbGV0IHByb3BOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKF9CbG9iKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcE5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBwcm9wTmFtZSA9IHByb3BOYW1lc1tpXTsKICAgICAgaWYgKHByb3BOYW1lIGluIHNlY3VyZUJsb2IpIHsKICAgICAgICBjb250aW51ZTsgLy8gU2tpcCBhbHJlYWR5IGV4aXN0aW5nIHByb3BzCiAgICAgIH0KICAgICAgbGV0IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKF9CbG9iLCBwcm9wTmFtZSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzZWN1cmVCbG9iLCBwcm9wTmFtZSwgZGVzYyk7CiAgICB9CgogICAgc2VjdXJlQmxvYi5wcm90b3R5cGUgPSBfQmxvYi5wcm90b3R5cGU7CiAgICByZXR1cm4gc2VjdXJlQmxvYjsKICB9KEJsb2IpOwoKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgaWYgKGV2ZW50LnNvdXJjZSAhPT0gd2luZG93KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IG1lc3NhZ2UgPSBldmVudC5kYXRhOwogICAgc3dpdGNoIChtZXNzYWdlLm1ldGhvZCkgewogICAgICBjYXNlICd1cGRhdGVMb2NhdGlvbic6CiAgICAgICAgaWYgKCh0eXBlb2YgbWVzc2FnZS5pbmZvID09PSAnb2JqZWN0JykgJiYgKHR5cGVvZiBtZXNzYWdlLmluZm8uY29vcmRzID09PSAnb2JqZWN0JykpIHsKICAgICAgICAgIGhvb2tlZE9iai5nZW5MYXQgPSBtZXNzYWdlLmluZm8uY29vcmRzLmxhdDsKICAgICAgICAgIGhvb2tlZE9iai5nZW5Mb24gPSBtZXNzYWdlLmluZm8uY29vcmRzLmxvbjsKICAgICAgICAgIGhvb2tlZE9iai5mYWtlR2VvID0gbWVzc2FnZS5pbmZvLmZha2VJdDsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfSwgZmFsc2UpOwogIC8vXV0+Cn0KICAgICAgICAgICkoKTs8L3NjcmlwdD48ZGVmcy8+PGc+PHJlY3QgeD0iMTYiIHk9IjU2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDc2cHg7IG1hcmdpbi1sZWZ0OiAxN3B4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48c3BhbiBzdHlsZT0iZm9udC1zaXplOiAxOHB4OyI+5pyN5YqhMTwvc3Bhbj48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjxwYXRoIGQ9Ik0gNjYgMTg2IEwgNjYgOTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIzIDMiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cmVjdCB4PSIxNzYiIHk9IjU2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDc2cHg7IG1hcmdpbi1sZWZ0OiAxNzdweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PGZvbnQgc3R5bGU9ImZvbnQtc2l6ZTogMThweDsiPuacjeWKoTI8L2ZvbnQ+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cGF0aCBkPSJNIDIyNiAyNjQgTCAyMjYgOTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIzIDMiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cmVjdCB4PSI0MTYiIHk9IjU2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDc2cHg7IG1hcmdpbi1sZWZ0OiA0MTdweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PGZvbnQgc3R5bGU9ImZvbnQtc2l6ZTogMThweDsiPlJlZGlzPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDMxcHg7IG1hcmdpbi1sZWZ0OiAxN3B4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBzdHlsZT0iZm9udC1zaXplOiAxNHB4OyI+QVAv5bqU55So56iL5bqPPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PHJlY3QgeD0iMTc2IiB5PSIxNiIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogOThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAzMXB4OyBtYXJnaW4tbGVmdDogMTc3cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPjxzcGFuIHN0eWxlPSJmb250LXNpemU6IDE0cHg7Ij5BUC/lupTnlKjnqIvluo88L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cmVjdCB4PSI0MTYiIHk9IjE2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDMxcHg7IG1hcmdpbi1sZWZ0OiA0MTdweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTogMTRweDsiPue8k+WtmDwvc3Bhbj48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjxyZWN0IHg9IjYxIiB5PSIxODYiIHdpZHRoPSIxMCIgaGVpZ2h0PSIyNTAiIGZpbGw9IiNmZmY5YzQiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxwYXRoIGQ9Ik0gNjYgNTA2IEwgNjUuNSA0MzYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIzIDMiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cmVjdCB4PSI0NjEiIHk9IjM0NiIgd2lkdGg9IjEwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDQ2NS42MSA0MzYgTCA0NjUgNDA0Ljk4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA3MSAyMTMuNzUgTCAxMTYgMjEzLjggTCAxMTYgMzkzLjggTCA3OS4xMiAzOTMuNzYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA3Mi4xMiAzOTMuNzUgTCA3OS4xMiAzOTAuMjYgTCA3OS4xMSAzOTcuMjYgWiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBmbGV4LXN0YXJ0OyB3aWR0aDogMXB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDMwNHB4OyBtYXJnaW4tbGVmdDogMTIwcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGxlZnQ7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDExcHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmZmZmOyB3aGl0ZS1zcGFjZTogbm93cmFwOyAiPjxmb250IHN0eWxlPSJmb250LXNpemU6IDE0cHg7Ij48Zm9udCBjb2xvcj0iI2ZmMzMzMyI+wqDov5vnqIvmmoLlgZwvPGJyIC8+572R57uc5bu25pe2PC9mb250PjxiciAvPjwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjxwYXRoIGQ9Ik0gNDY2IDM0NiBMIDQ2NiA5NiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS1kYXNoYXJyYXk9IjMgMyIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxyZWN0IHg9IjU3NiIgeT0iNTYiIHdpZHRoPSIxMDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmY5YzQiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDk4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogNzZweDsgbWFyZ2luLWxlZnQ6IDU3N3B4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBzdHlsZT0iZm9udC1zaXplOiAxOHB4OyI+REI8L2ZvbnQ+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cGF0aCBkPSJNIDYyNiAxNTYgTCA2MjYgOTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIzIDMiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cmVjdCB4PSI1NzYiIHk9IjE2IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA5OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDMxcHg7IG1hcmdpbi1sZWZ0OiA1NzdweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTogMTRweDsiPuaVsOaNruW6kzwvc3Bhbj48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjxyZWN0IHg9IjYyMSIgeT0iMTU2IiB3aWR0aD0iMTAiIGhlaWdodD0iNzAiIGZpbGw9IiNmZmY5YzQiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxwYXRoIGQ9Ik0gNjI2Ljc4IDI1NyBMIDYyNyAyMjcuNzUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIzIDMiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDcxIDE5OC4yNSBMIDU5OS42MyAxOTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2MDQuODggMTk4IEwgNTk3Ljg4IDIwMS41IEwgNTk5LjYzIDE5OCBMIDU5Ny44OCAxOTQuNSBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDFweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxOThweDsgbWFyZ2luLWxlZnQ6IDMzOXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDExcHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmZmZmOyB3aGl0ZS1zcGFjZTogbm93cmFwOyAiPjxzcGFuIHN0eWxlPSJmb250LXNpemU6IDE0cHg7Ij4xLiDnvJPlrZjml6DmlbDmja7vvIzmn6Xor6JEQiDnu5PmnpzkuLogdjE8YnIgLz48L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cmVjdCB4PSIyMjEiIHk9IjI2NiIgd2lkdGg9IjEwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDIzNCAyNzYgTCA2MTQuNjMgMjc2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gNjE5Ljg4IDI3NiBMIDYxMi44OCAyNzkuNSBMIDYxNC42MyAyNzYgTCA2MTIuODggMjcyLjUgWiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAxcHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjc2cHg7IG1hcmdpbi1sZWZ0OiA0MjhweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMXB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgIj48c3BhbiBzdHlsZT0iZm9udC1zaXplOiAxNHB4OyI+My4g57yT5a2Y5peg5pWw5o2u77yM5p+l6K+iREIg57uT5p6c5Li6djI8YnIgLz48L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cGF0aCBkPSJNIDIyNSAzNDYuNDkgTCA0NDkuNjMgMzQ2LjAxIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gNDU0Ljg4IDM0NiBMIDQ0Ny44OSAzNDkuNTIgTCA0NDkuNjMgMzQ2LjAxIEwgNDQ3Ljg3IDM0Mi41MiBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDFweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAzNDZweDsgbWFyZ2luLWxlZnQ6IDM0MXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDExcHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmZmZmOyB3aGl0ZS1zcGFjZTogbm93cmFwOyAiPjxzcGFuIHN0eWxlPSJmb250LXNpemU6IDE0cHg7Ij40LiDlhpnlhaXnvJPlrZggdjI8YnIgLz48L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cGF0aCBkPSJNIDcxIDQzNi40OSBMIDQ1NS42MyA0MzUuMDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA0NjAuODggNDM1IEwgNDUzLjkgNDM4LjUzIEwgNDU1LjYzIDQzNS4wMiBMIDQ1My44NyA0MzEuNTMgWiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAxcHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogNDM2cHg7IG1hcmdpbi1sZWZ0OiAyNjdweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMXB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgIj48c3BhbiBzdHlsZT0iZm9udC1zaXplOiAxNHB4OyI+PGZvbnQgY29sb3I9IiNmZjMzMzMiPjUuIOWGmeWFpee8k+WtmCB2MTwvZm9udD48YnIgLz48L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cmVjdCB4PSI0NjEiIHk9IjQzNiIgd2lkdGg9IjEwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmOWM0IiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDQ2NiA1MDYgTCA0NjYgNDc2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2NzYgMjU2IEwgNjg2IDI1NiBRIDY5NiAyNTYgNjg2IDI1NiBMIDY4MSAyNTYgUSA2NzYgMjU2IDY2NiAyNTYgTCA2MzMuMjQgMjU2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2NDEuMTIgMjUxLjUgTCA2MzIuMTIgMjU2IEwgNjQxLjEyIDI2MC41IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBmbGV4LWVuZDsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMXB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDI1M3B4OyBtYXJnaW4tbGVmdDogNjczcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTFweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGJhY2tncm91bmQtY29sb3I6ICNmZmZmZmY7IHdoaXRlLXNwYWNlOiBub3dyYXA7ICI+PGZvbnQgc3R5bGU9ImZvbnQtc2l6ZTogMTRweDsiPjIg5YaZ5YWldjI8L2ZvbnQ+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48cmVjdCB4PSI2MjEiIHk9IjI1NyIgd2lkdGg9IjEwIiBoZWlnaHQ9IjIwOSIgZmlsbD0iI2ZmZjljNCIgc3Ryb2tlPSIjMDAwMDAwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHBhdGggZD0iTSA2NzYgMTY2IEwgNjg2IDE2NiBRIDY5NiAxNjYgNjg2IDE2NiBMIDY4MSAxNjYgUSA2NzYgMTY2IDY2NiAxNjYgTCA2MzMuMjQgMTY2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2NDEuMTIgMTYxLjUgTCA2MzIuMTIgMTY2IEwgNjQxLjEyIDE3MC41IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBmbGV4LWVuZDsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMXB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDE2M3B4OyBtYXJnaW4tbGVmdDogNjczcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTFweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGJhY2tncm91bmQtY29sb3I6ICNmZmZmZmY7IHdoaXRlLXNwYWNlOiBub3dyYXA7ICI+PGZvbnQgc3R5bGU9ImZvbnQtc2l6ZTogMTRweDsiPuWIneWni+S4uiB2MTwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48L3N2Zz4="></div><p></p>
<p><a href="https://github.com/dtm-labs" rel="nofollow">dtm-labs</a> 致力于解决数据一致性问题，在分析了行业的现有做法后，提出了新解决方案 <a href="https://github.com/dtm-labs/dtm" rel="nofollow">dtm-labs/dtm</a>+<a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a>，彻底解决了上述问题。另外作为一个成熟方案，该方案还可以防缓存穿透，防缓存击穿，防缓存雪崩，同时也可应用于要求数据强一致的场景。</p>
<p>关于管理缓存的现有方案，本文不再赘述，不太了解的同学可以参考下面这两篇文章</p>
<ul>
<li>这篇通俗易懂些：<a href="https://juejin.cn/post/6844903941646319623" rel="nofollow">聊聊数据库与缓存数据一致性问题</a></li>
<li>这篇更加深入：<a href="https://www.infoq.cn/article/hh4iouiijhwb4x46vxeo" rel="nofollow">携程最终一致和强一致性缓存实践</a></li>
</ul>
<h2 id="sr-toc-1">乱序产生的不一致</h2>
<p>在上述这个时序图中，由于服务 1 发生了进程暂停（例如由于 GC 导致），因此当它往缓存当中写入 v1 时，覆盖了缓存中的 v2 ，导致了最终的不一致（ DB 中为 v2 ，缓存中为 v1 ）。</p>
<p>对于上述这类问题应当如何解决？目前现存的方案，全都没有彻底解决该问题，一般都是通过设定稍短的过期时间兜底。我们实现的缓存延迟删除方案，能够彻底解决这个问题，确保缓存与数据库之间的数据保持一致。解决原理如下：</p>
<p>缓存中的数据是一个 hash ，里面有以下几个字段：</p>
<ul>
<li>value: 数据本身</li>
<li>lockUtil: 数据锁定到期时间，当某个进程查询缓存无数据，那么先锁定缓存一小段时间，然后查询 DB ，然后更新缓存</li>
<li>owner: 数据锁定者 uuid</li>
</ul>
<p>查询缓存时：</p>
<ol>
<li>如果数据为空，且被锁定，则睡眠 1s 后，重新查询</li>
<li>如果数据为空，且未被锁定，同步执行 "取数据"，返回结果</li>
<li>如果数据不为空，那么立即返回结果，并异步执行 "取数据"</li>
</ol>
<p>其中 "取数据" 的操作定义为：</p>
<ol>
<li>
判断是否需要更新缓存，下面两个条件满足其一，则需要更新缓存<ul>
<li>数据为空，并且未被锁定</li>
<li>数据的锁定已过期</li>
</ul>
</li>
<li>如果需要更新，则锁定缓存，查询 DB ，校验锁持有者无变化，写入缓存，解锁缓存</li>
</ol>
<p>当 DB 数据更新时，通过 dtm 确保数据更新成功时，将缓存延迟删除（将在后面一节展开详细讲解）</p>
<ul>
<li>延迟删除会将数据过期时间设定为 10s ，将锁设置为已过期，触发下一次查询缓存时的 “取数据”</li>
</ul>
<p>在上述的策略下：
假如最后写入数据库的版本为 Vi ，最后写入到缓存的版本为 V ，写入 V 的 uuid 为 uuidv ，那么一定存在以下事件序列：</p>
<p>数据库写入 Vi -&gt; 缓存数据被标记为删除 -&gt; 某个查询锁定数据并写入 uuidv -&gt; 查询数据库结果 V -&gt; 缓存中的锁定者为 uuidv ，写入结果 V</p>
<p>在这个序列中，V 的读取发生在写入 Vi 之后，所以 V 等于 Vi ，保证了缓存的数据的最终一致性。</p>
<p><a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 已经实现了上述方法，能够确保缓存数据的最终一致性。</p>
<ul>
<li><code>Fetch</code>函数实现了前面的查询缓存</li>
<li><code>DelayDelete</code>函数实现了延迟删除逻辑</li>
</ul>
<p>感兴趣的同学，可以参考 <a href="https://github.com/dtm-labs/dtm-cases/tree/main/cache" rel="nofollow">dtm-cases/cache</a>，里面有详细的例子</p>
<h2 id="sr-toc-2">DB 与缓存操作的原子性</h2>
<p>对于缓存的管理，一般业界会采用写完数据库后，删除 / 更新缓存数据的策略。由于保存到缓存和保存到数据库两个操作之间不是原子的，一定会有时间差，因此这两个数据之间会有一个不一致的时间窗口，通常这个窗口不大，影响较小。但是两个中间可能发生宕机，也可能发生各种网络错误，因此就有可能发生完成了其中一个，但是未完成另一个，导致数据会出现长时间不一致。</p>
<p>举一个场景来说明上述不一致的情况，数据用户将数据 A 修改为 B ，应用修改完数据库之后，再去删除 / 更新缓存，如果未发生异常，那么数据库和缓存的数据是一致的，没有问题。但是分布式系统中，可能会发生进程 crash 、宕机等事件，因此如果更新完数据库，尚未删除 / 更新缓存时，出现进程 crash ，那么数据库和缓存的数据就可能出现长时间的不一致。</p>
<p>面对这里的长时间不一致的情况，想要彻底解决，并不是一件容易的事，我们下面分各种应用情况来介绍解决方案。</p>
<h4 id="sr-toc-3">方案一：较短的缓存时间</h4>
<p>这个方案，是最简单的方案，适合并发量不大应用。如果应用的并发不高，那么整个缓存系统，只需要设置了一个较短的缓存时间，例如一分钟。这种情况下数据库需要承担的负载是：大约每一分钟，需要将访问到的缓存数据全部生成一遍，在并发量不大的情况下，这种策略是可行的。</p>
<p>上述这种策略非常简单，易于理解和实现，缓存系统提供的语义是，大多数情况下，缓存和数据库之间不一致的时间窗口是很短的，在较低概率发生进程 crash 的情况下，不一致的时间窗口会达到一分钟。</p>
<p>应用在上述约束下，需要将一致性要求不高的数据读取，从缓存读取；而将一致性要求较高的读，不走缓存，直接从数据库查询。</p>
<h4 id="sr-toc-4">方案二：消息队列保证一致</h4>
<p>假如应用的并发量很高，缓存过期时间需要比一分钟更长，而且应用中的大量请求不能够容忍较长时间的不一致，那么这个时候，可以通过使用消息队列的方式，来更新缓存。具体的做法是：</p>
<ul>
<li>更新数据库时，同时将更新缓存的消息写入本地表，随着数据库更新操作的提交而提交。</li>
<li>写一个轮询任务，不断轮询这部分消息，发给消息队列。</li>
<li>消费消息队列中的消息，更新 / 删除缓存</li>
</ul>
<p>这种做法可以保证数据库更新之后，缓存一定会被更新。但这种这种架构方案很重，这几个部分开发维护成本都不低：消息队列的维护；高效轮询任务的开发与维护。</p>
<h4 id="sr-toc-5">方案三：订阅 binlog</h4>
<p>这个方案适用场景与方案二非常类似，原理又与数据库的主从同步类似，数据库的主从同步是通过订阅 binlog ，将主库的更新应用到从库上，而这个方案则是通过订阅 binlog ，将数据库的更新应用到缓存上。具体做法是：</p>
<ul>
<li>部署并配置阿里开源的 canal ，让它订阅数据库的 binlog</li>
<li>通过 canal 等工具 监听数据更新，同步更新 / 删除缓存</li>
</ul>
<p>这种方案也可以保证数据库更新之后，缓存一定会被更新，但是这种架构方案跟前面的消息队列方案一样，也非常重。一方面 canal 的学习维护成本不低，另一方面，开发者可能只需要少量数据更新缓存，通过订阅所有的 binlog 来做这个事情，浪费了很多资源。</p>
<h4 id="sr-toc-6">方案四：dtm 二阶段消息方案</h4>
<p>dtm 里的二阶段消息模式，非常适合这里的修改数据库之后更新 / 删除缓存，主要代码如下：</p>
<pre class="hljs perl">msg := dtmcli.NewMsg(DtmServer, gid).
	Add(busi.Busi+<span class="hljs-string">"/UpdateRedis"</span>, &amp;Re<span class="hljs-string">q{Key: key1}</span>)
err := msg.DoAndSubmitDB(busi.Busi+<span class="hljs-string">"/QueryPrepared"</span>, db, func(tx *sql.Tx) error {
  <span class="hljs-regexp">//</span> update db data with key1
})</pre>
<p>这段代码，DoAndSubmitDB 会进行本地数据库操作，进行数据库的数据修改，修改完成后，会提交一个二阶段消息事务，消息事务将会异步调用 UpdateRedis 。假如本地事务执行之后，就立刻发生了进程 crash 事件，那么 dtm 会进行回查调用 QueryPrepared ，保证本地事务提交成功的情况下，UpdateRedis 会被最少成功执行一次。</p>
<p>回查的逻辑非常简单，只需要 copy 类似下面这样的代码即可：</p>
<pre class="hljs cs">app.GET(BusiAPI+<span class="hljs-string">"/QueryPrepared"</span>, dtmutil.WrapHandler(func(c *gin.Context) <span class="hljs-keyword">interface</span>{} {
		<span class="hljs-keyword">return</span> MustBarrierFromGin(c).QueryPrepared(dbGet())
	}))</pre>
<p>这种方案的优点：</p>
<ul>
<li>方案简单易用，代码简短易读</li>
<li>dtm 本身是一个无状态的普通应用，依赖的存储引擎 redis/mysql 是常见的基础设施，不需要额外维护消息队列或者 canal</li>
<li>相关的操作模块化，易维护，不需要像消息队列或者 canal 在其他地方写消费者的逻辑</li>
</ul>
<h4 id="sr-toc-7">从库延时</h4>
<p>上述的方案中，假定缓存删除后，服务进行数据查询，总是能够查到最新的数据。但是实际的生产环境中，可能会出现主从分离的架构，而主从延时并不是一个可控的变量，那么这时候又要怎么处理？</p>
<p>处理方案两种：一是区分最终一致性很高和不高的缓存数据，查询数据时，将要求很高的数据必须从主库读取，而把要求不高的数据从从库读取。对于使用了 rockscache 的应用来说，高并发的请求都会在 Redis 这一层被拦截，对于一个数据，最多只会有一个请求到达数据库，因此数据库的负载已大幅降低，采用主库读取是一个实际可行的方案。</p>
<p>另一种方案是，主从分离需要采用不分叉的单链架构，那么链条末尾的从库必定是延迟最长的从库，此时采用监听 binlog 的方案，需要监听链条做末端的从库 binlog ，当收到数据变更通知时，按照上述方案将缓存标记为延迟删除。</p>
<p>这两个方案各有优缺点，业务可以根据自己的特点采用。</p>
<h2 id="sr-toc-8">防缓存击穿</h2>
<p>rockscache 还可以防缓存击穿。当数据变更时，业界现有做法既可以选择更新缓存，也可以选择删除缓存，各有优劣。而延迟删除综合了两种方法的优势，并克服了两种方法的劣势：</p>
<h4 id="sr-toc-9">更新缓存</h4>
<p>采取更新缓存策略，那么会为所有的 DB 数据更新生成缓存，不区分冷热数据，那么会存在以下问题：</p>
<ul>
<li>内存上，即使一个数据没有被读取，也会保存在缓存里，浪费了宝贵的内存资源；</li>
<li>在计算上，即使一个数据没有被读取，也可能因为多次更新，被多次计算，浪费了宝贵的计算资源。</li>
<li>上述的乱序不一致发生的概率会较高，当两个临近的更新中出现延迟，就可能触发。</li>
</ul>
<h4 id="sr-toc-10">删除缓存</h4>
<p>因为前面的更新缓存做法问题较多，因此大多数的实践采用的是删除缓存策略，查询时再按需生成缓存。这种做法解决了更新缓存中的问题，但是又带来新问题：</p>
<ul>
<li>那么在高并发的情况下，如果删除了一个热点数据，那么此时会有大量请求会无法命中缓存，产生缓存击穿。</li>
</ul>
<p>为了防止缓存击穿，通用的做法是使用分布式 Redis 锁保证只有一个请求到数据库，等缓存生成之后，其他请求进行共享。这种方案能够适合很多的场景，但有些场景却不适合。</p>
<ul>
<li>例如有一个重要的热点数据，计算代价比较高，需要 3s 才能够获得结果，那么上述方案在删除一个这种热点数据之后，就会在这个时刻，有大量请求 3s 才返回结果，一方面可能造成大量请求超时，另一方面 3s 没有释放链接，会导致并发连接数量突然升高，可能造成系统不稳定。</li>
<li>另外使用 Redis 锁时，未获得锁的这部分用户，通常会定时轮询，而这个睡眠时间不好设定。如果设定比较大的睡眠时间 1s ，那么对于 10ms 就计算出结果的缓存数据，返回太慢了；如果设定的睡眠时间太短，那么很消耗 CPU 和 Redis 性能</li>
</ul>
<h4 id="sr-toc-11">延迟删除法的应对策略</h4>
<p>前面介绍的 <a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 实现的延时删除法也属于删除法，但它彻底解决了删除缓存中的击穿问题，以及击穿带来的附带问题。</p>
<ol>
<li>缓存击穿问题：延迟删除法中，如果缓存中的数据不存在，那么会锁定缓存中的这条数据，因此避免了多个请求打到后端数据库。</li>
<li>上述大量请求 3s 才返回数据，以及定时轮询的问题，在延时删除中也不存在，因为热点数据被延时删除时，旧版本的数据还在缓存中，会被立即返回，无需等待。</li>
</ol>
<p>我们来看看不同的数据访问频率下，延迟删除法的表现如何：</p>
<ol>
<li>热点数据，每秒 1K qps ，计算缓存时间 5ms ，此时延迟删除法，大约 5~8ms 左右的时间里，会返回过期数据，而先更新 DB ，再更新缓存，因为更新缓存需要时间，也会有大约 0~3ms 返回过期数据，因此两者差别不大。</li>
<li>热点数据，每秒 1K qps ，计算缓存时间 3s ，此时延迟删除法，大约 3s 的时间里，会返回过期数据。对比于等待 3s 后再返回数据，那么返回旧数据，通常是更好的行为。</li>
<li>普通数据，每秒 50 qps ，计算缓存时间 1s ，此时延迟删除法的行为分析，类似 2 ，没有问题。</li>
<li>低频数据，5 秒访问一次，计算缓存时间 3s ，此时延迟删除法的行为与删除缓存策略基本一样，没有问题</li>
<li>冷数据，10 分钟访问一次，此时延迟删除法，与删除缓存策略基本一样，只是数据比删除缓存的方式多保存 10s ，占用空间不大，没有问题</li>
</ol>
<p>有一种极端情况是，那就是原先缓存中没有数据，突然大量请求到来，这种场景对，更新缓存法删除缓存法，延迟删除法，都是不友好的。这种的场景是开发人员需要避免的，需要通过预热来解决，而不应当直接扔给缓存系统。当然，由于延迟删除法已经把打到数据库的请求量降到最低，因此表现也不弱于任何其他方案。</p>
<h2 id="sr-toc-12">防缓存穿透与缓存雪崩</h2>
<p><a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 还实现了防缓存穿透与缓存雪崩。</p>
<p>缓存穿透是指，缓存和数据库都没有的数据，被大量请求。由于数据不存在，缓存就也不会存在该数据，所有的请求都会直接穿透到数据库。rockscache 中可以设定<code>EmptyExipire</code>设定对空结果的缓存时间，如果设定为 0 ，那么不缓存空数据，关闭防缓存穿透</p>
<p>缓存雪崩是指缓存中有大量的数据，在同一个时间点，或者较短的时间段内，全部过期了，这个时候请求过来，缓存没有数据，都会请求数据库，则数据库的压力就会突增，扛不住就会宕机。rockscache 可以设定<code>RandomExpireAdjustment</code>，对过期时间加上随机值，避免同时过期。</p>
<h2 id="sr-toc-13">应用能否做到强一致？</h2>
<p>上面已经介绍了缓存一致性的各种场景，以及相关的解决方案，那么是否可以保证使用缓存的同时，还提供强一致的数据读写呢？强一致的读写需求比前面的最终一致的需求场景少，但是在金融领域，也是有不少场景的。</p>
<p>当我们在这里讨论强一致时，我们需要先把一致性的含义做一下明确。</p>
<p>开发者最直观的强一致性很可能理解为，数据库和缓存保持完全一致，写数据的过程中以及写完之后，无论从数据库直接读，或者从缓存直接读，都能够获得最新写入的结果。对于这种两个独立系统之间的 “强一致性”，可以非常明确的说，理论上是不可能的，因为更新数据库和更新缓存在不同的机器上，无法做到同时更新，无论如何都会有时间间隔，在这个时间间隔里，一定是不一致的。</p>
<p>但是应用层的强一致性，则是可以做到的。可以简单考虑我们熟悉的场景：CPU 的缓存作为内存的缓存，内存作为磁盘的缓存，这些都是缓存的场景，从来没有发生过一致性问题。为什么？其实很简单，要求所有的数据使用方，只能够从缓存读取数据，而不能同时从缓存和底层存储同时读取数据。</p>
<p>对于 DB 和 Redis ，如果所有的数据读取，只能够由缓存提供，就可以很容易的做到强一致，不会出现不一致的情况。下面我们来根据 DB 和 Redis 的特点，来分析其中的设计：</p>
<h4 id="sr-toc-14">先更新缓存还是 DB</h4>
<p>类比 CPU 缓存与内存，内存缓存与磁盘，这两个系统都是先修改缓存，再修改底层存储，那么到了现在的 DB 缓存场景是否也先修改缓存再修改 DB ？</p>
<p>在绝大多数的应用场景下，开发者会认为 Redis 作为缓存，当 Redis 出现故障时，那么应用需要支持降级处理，依旧能够访问数据库，提供一定的服务能力。考虑这种场景，一旦出现降级，先写缓存再写 DB 方案就有问题，一方面会丢失数据，另一方面会发生先读取到缓存中的新版本 v2 ，再读取到旧版本 v1 。因此在 Redis 作为缓存的场景下，绝大部分系统会采取先写入 DB ，再写入缓存的这种设计</p>
<h4 id="sr-toc-15">写入 DB 成功缓存失败情况</h4>
<p>假如因为进程 crash ，导致写入 DB 成功，但是标记延迟删除第一次失败怎么办？虽然间隔几秒之后，会重试成功，但这几秒钟的时间里，用户去读取缓存，依旧还是旧版本的数据。例如用户发起了一笔充值，资金已经进入到 DB ，只是更新缓存失败，导致从缓存看到的余额还是旧值。这种情况的处理很简单，用户充值时，写入 DB 成功时，应用不要给用户返回成功，而是等缓存更新也成功了，再给用户返回成功；用户查询充值交易时，要查询 DB 和缓存是否都成功了（可以查询二阶段消息全局事务是否已成功），只有两者都成功了，才返回成功。</p>
<p>在上述的处理策略下，当用户发起充值后，在缓存更新完成之前，用户看到的是，这笔交易还在处理中，结果未知，此时是符合强一致要求的；当用户看到交易已经处理成功，也就是缓存已更新成功，那么所有从缓存中拿到的数据都是更新后的数据，那么也符合强一致的要求。</p>
<p><a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 也实现了强一致的读取需求。当打开<code>StrongConsistency</code>选项，那么 rockscache 里<code>Fetch</code>函数就提供了强一致的缓存读取。其原理与延迟删除差别不大，仅做了很小的改变，就是不再返回旧版本的数据，而是同步等待 “取数据” 的最新结果</p>
<p>当然这个改变会带来性能上的下降，对比与最终一致的数据读取，强一致的读取一方面要等待当前 “取数据” 的最新结果，增加了返回延迟，另一方面要等待其他进程的结果，会产生 sleep 等待，耗费资源。</p>
<h2 id="sr-toc-16">缓存降级升级中的强一致</h2>
<p>上述的强一致方案中，说明了其强一致的前提是：“所有的数据读取，只能够由缓存”。不过如果 Redis 如果发生故障，需要进行降级，那么降级的过程可能很短只有几秒，但是这个几秒内如果不能接受不可访问，还严苛的要求提供访问的话，就会出现读取缓存和读取 DB 混用情况，就不满足这个前提。不过因为 Redis 故障的频率不高，要求强一致性的应用通常配备专有 Redis ，因此遇见故障降级的概率很低，很多应用不会在这个地方提出苛刻的要求。</p>
<p>不过 dtm-labs 作为数据一致性领域的领导者，也深入研究了这个问题，并给出这种苛刻条件下的解决方案。</p>
<h4 id="sr-toc-17">升降级的过程</h4>
<p>现在我们来考虑应用在 Redis 缓存出现问题的升降级处理。一般情况下这个升降级的开关在配置中心，当修改配置后，各个应用进程会陆续收到降级配置变更通知，然后在行为上降级。在降级的过程中，会出现缓存与 DB 混合访问的情况，这时我们上面的方案就有可能出现不一致。那么如何处理才能够保证在这种混合访问的情况下，依旧能够让应用获取到强一致的结果呢？</p>
<p>混合访问的过程中，我们可以采取下面这个策略，来保证 DB 和缓存混合访问时的数据一致性。</p>
<ul>
<li>
更新数据时，使用分布式事务，保证以下操作为原子操作<ul>
<li>将缓存标记为 “锁定中”</li>
<li>更新 DB</li>
<li>将缓存 “锁定中” 标记去除，标记为延迟删除</li>
</ul>
</li>
<li>读取缓存数据时，对于标记为 “锁定中” 的数据，睡眠等待后再次读取；对于延迟删除的数据，不返回旧数据，等待新数据完成再返回。</li>
<li>读取 DB 数据时，直接读取，无需任何额外操作</li>
</ul>
<p>这个策略跟前面不考虑降级场景的强一致方案，差别不大，读数据部分完全不变，需要变的是更新数据。rockscache 假定更新 DB 是一个业务上可能失败的操作，于是采用一个 SAGA 事务来保证原子操作，详情参见例子 <a href="https://github.com/dtm-labs/dtm-cases/tree/main/cache" rel="nofollow">dtm-cases/cache</a></p>
<p>升降级的开启关闭有顺序要求，不能够同时开启缓存读和写，而是需要在开启缓存读的时候，所有的写操作都已经确保会更新缓存。</p>
<p>降级的详细过程如下：</p>
<ol>
<li>
最初状态：<ul>
<li>读：混合读</li>
<li>写：DB + 缓存</li>
</ul>
</li>
<li>
读降级：<ul>
<li>读：关闭缓存读。混合读 =&gt; 全部 DB 读</li>
<li>写：DB + 缓存</li>
</ul>
</li>
<li>
写降级：<ul>
<li>读：全部 DB 读；</li>
<li>写：关闭缓存写。DB + 缓存 =&gt; 只写 DB</li>
</ul>
</li>
</ol>
<p>升级的过程与此相反，如下：</p>
<ol>
<li>
最初状态：<ul>
<li>读：全部读 DB</li>
<li>写：全部只写 DB</li>
</ul>
</li>
<li>
写升级：<ul>
<li>读：全部读 DB</li>
<li>写：打开写缓存。只写 DB =&gt; 写 DB + 缓存</li>
</ul>
</li>
<li>
读升级：<ul>
<li>读：部分读缓存。全部读 DB =&gt; 混合读</li>
<li>写：写 DB + 缓存</li>
</ul>
</li>
</ol>
<p><a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 已实现了上述强一致的缓存管理方法。</p>
<p>感兴趣的同学，可以参考 <a href="https://github.com/dtm-labs/dtm-cases/tree/main/cache" rel="nofollow">dtm-cases/cache</a>，里面有详尽的例子</p>
<h2 id="sr-toc-18">小结</h2>
<p>这篇文章很长，许多的分析比较晦涩，最后将 Redis 缓存的使用方式做个总结：</p>
<ul>
<li>最简单的方式为：较短的缓存时间，允许少量数据库修改，未同步删除缓存</li>
<li>保证最终一致，并且可防缓存击穿的方式为：二阶段消息 + 延迟删除 (rockscache)</li>
<li>强一致：二阶段消息 + 强一致 (rockscache)</li>
<li>一致性要求最严苛的方式为：二阶段消息 + 强一致 (rockscache)+ 升降级兼容</li>
</ul>
<p>对于后两种方式，我们都推荐使用 <a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 来作为您的缓存方案</p>
<p>欢迎访问 <a href="https://github.com/dtm-labs/rockscache" rel="nofollow">dtm-labs/rockscache</a> 和 <a href="https://github.com/dtm-labs/dtm" rel="nofollow">dtm-labs/dtm</a>，并 star 支持我们</p>
</div></div><p></p></sr-rd-content>
                            </sr-read>
                        </body>
                    </html>